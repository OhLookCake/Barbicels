from __future__ import print_function
import numpy as np
from joblib import Parallel, delayed
import sys
import cma
import commands
import pickle

"""
argv[1]: config file
"""
def fitnessfunc(wctr, weights, gamesperagent):
	namevec = ['9_3', '10_2', '8_21', '9_27', '9_11', '7_47', '8_12', '2_4', '10_11', '7_41', '10_13', '7_1', '7_29', '9_19', '8_23', '7_15', '9_44', '7_17', '7_33', '9_38', '4_10', '7_35', '2_22', '7_2', '9_9', '10_1', '10_25', '4_30', '3_12'] 
	print(str(wctr)+ " " + namevec[wctr])
	sys.stdout.flush()	
	cmd = "sh runall.sh " + str(gamesperagent) + " 123 " + str(wctr) + " " + sys.argv[1] + " 1 " + " ".join([str(w) for w in weights])
	print("CMD: " +cmd)
	sys.stdout.flush()	
	output = commands.getoutput(cmd)
	print(output)
	sys.stdout.flush()
	fitness = int(output)
	print("Agent " + str(wctr) + ": " + namevec[wctr] + "\n\tWeights = " + str(weights) + "\n\tFitness=" + str(fitness))
	sys.stdout.flush()
	return (weights, fitness)
if __name__=="__main__":

	#PARAMS
	gamesperagent = 250


	weightvecvec=	[[10.1285215592, -3.38579932486, 1.6420283269, 7.01097695432, -2.86730422795] ,
	[7.19628553474, 0.55928953622, 5.46277893444, 11.5749224438, 2.38553098799] ,
	[6.4410146066, -5.06895440132, -0.145374177335, 11.5301166702, -1.42879132157] ,
	[5.99365852227, 0.021382451627, 4.50201549774, 11.9513077612, -1.56174360646] ,
	[6.14360277128, -2.69208757176, 2.31072517063, 11.4599014889, -1.43478134346] ,
	[6.81406291009, -1.34976966577, 4.35953294322, 12.5153679154, -3.73622082419] ,
	[5.22707357173, 0.289676203288, 1.93853482115, 8.5231328638, -0.506607126412] ,
	[5.9272103235, -1.28406882001, 1.90686107487, 6.58225699794, 1.48764496857] ,
	[7.11870636549, -3.68166746262, 3.51714091145, 9.50675854735, -2.20087996678] ,
	[8.35470163728, -4.64215290708, 6.37921504611, 10.9305443693, -4.63041953741] ,
	[6.28704769111, -3.34085674338, 0.930691410753, 8.92474785962, -1.25904775197] ,
	[8.18191868833, -5.00977735663, 2.5908817206, 11.869394972, 0.191324849791] ,
	[6.68385169309, -1.43692030864, 5.34508802128, 12.3045123076, 0.172988362107] ,
	[8.31541508396, -4.5074380348, 2.66127818683, 10.6351625672, -5.21688981559] ,
	[7.67964893544, -3.2229730608, 2.30053765609, 9.25442853206, -4.17468568801] ,
	[7.62858055917, -3.59635621461, 0.0810286296415, 9.04363360326, -3.09894184208] ,
	[5.23422645813, -3.72140879682, 1.55422053334, 10.2518374013, -4.22365367254] ,
	[6.24854032153, -5.01584412692, 0.241092576595, 9.75453917801, 0.117262325808] ,
	[6.17002147784, -5.00411950749, 0.993524329521, 9.58916651623, -2.48016053918] ,
	[8.73070950514, -3.35673857855, 1.69853582573, 11.9737001348, -2.15540254607] ,
	[10.0208690177, -2.46581124862, -0.63845288668, 5.28960579319, -0.793191548546] ,
	[2.72377028133, 1.01765203659, 6.13622549583, 10.9268019473, -3.04101447262] ,
	[6.18262197808, -2.17391669709, 2.99172046481, 6.14690624643, 1.79947174856] ,
	[8.94170248152, -1.07655718632, 2.44504536735, 11.7876528024, -1.52073593071] ,
	[8.34792568395, -3.48271161396, 5.98665030316, 12.6329859197, -4.3889046042] ,
	[8.37700668214, -2.65627271775, 6.85994640928, 13.5250018276, -2.65086929293] ,
	[9.29587668401, -2.02492773926, 2.0285145135, 13.0231585081, -3.53285216971] ,
	[5.99302374483, -5.42585497764, 2.12473791298, 6.26741230501, -1.54880945445] ,
	[4.48161537781, -2.39255304384, 0.531879615468, 7.77362485951, -1.26859977147] ]
	
	namevec = ['9_3', '10_2', '8_21', '9_27', '9_11', '7_47', '8_12', '2_4', '10_11', '7_41', '10_13', '7_1', '7_29', '9_19', '8_23', '7_15', '9_44', '7_17', '7_33', '9_38', '4_10', '7_35', '2_22', '7_2', '9_9', '10_1', '10_25', '4_30', '3_12']



	with Parallel (n_jobs=4) as parallel:
		fitness_for_weights = parallel( delayed (fitnessfunc)
				(wctr, weights, gamesperagent)
				for (weights, wctr) in 
				zip (weightvecvec, range(len(weightvecvec)) ))
	
		sys.stdout.flush()	
		for i in fitness_for_weights:
			print(i)
			sys.stdout.flush()	
		fitnessvector= [ i[1] for i in fitness_for_weights]
		print(fitnessvector)
		sys.stdout.flush()

